<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Program Listing for File hal.c &#8212; PickPlaz ESP32-C3 Port 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" type="text/css" href="../../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=047d7ffa" />
    
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
    <script src="../../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PickPlaz ESP32-C3 Port 0.0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Program Listing for File hal.c</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="program-listing-for-file-hal-c">
<span id="program-listing-file-src-hal-c"></span><h1>Program Listing for File hal.c<a class="headerlink" href="#program-listing-for-file-hal-c" title="Link to this heading">¶</a></h1>
<p>↰ <a class="reference internal" href="../exhale-internal/file_src_hal.c.html#file-src-hal-c"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">src/hal.c</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * PickPlaz ESP32-C3 Port</span>
<span class="cm"> * Copyright (c) 2026 Asterion Daedalus https://github.com/Bazmundi</span>
<span class="cm"> * SPDX-License-Identifier: MIT</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of PickPlaz ESP32-C3 Port and is licensed under the MIT License.</span>
<span class="cm"> * See the LICENSE file in the project root for full license text.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * @file hal.c</span>
<span class="cm"> * @brief Implements the ESP32-C3 hardware abstraction layer.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Provides GPIO, timers, PWM, UART, SPI, I2C, ADC, and optional self-test</span>
<span class="cm"> * services using ESP-IDF drivers. The HAL hides platform specifics from the</span>
<span class="cm"> * application layer.</span>
<span class="cm"> *</span>
<span class="cm"> * Thread-safety:</span>
<span class="cm"> * - Not thread-safe; callers should serialize access when sharing resources.</span>
<span class="cm"> */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;hal.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;hal_config.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;esp_err.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;esp_log.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;esp_timer.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;driver/gpio.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;driver/i2c.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;driver/ledc.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;driver/spi_master.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;driver/uart.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;esp_adc/adc_oneshot.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;freertos/FreeRTOS.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;freertos/task.h&quot;</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hal&quot;</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">hal_gpio_valid</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pin</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">GPIO_IS_VALID_GPIO</span><span class="p">((</span><span class="n">gpio_num_t</span><span class="p">)</span><span class="n">pin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">hal_gpio_output_valid</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pin</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">GPIO_IS_VALID_OUTPUT_GPIO</span><span class="p">((</span><span class="n">gpio_num_t</span><span class="p">)</span><span class="n">pin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Initializes HAL services.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Performs lightweight HAL startup and logs the initialization banner.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - HAL services are available to callers.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Writes a log message.</span>
<span class="cm"> *</span>
<span class="cm"> * @return HAL_OK on success.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HAL init (Stage 3)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Delays execution for the requested number of milliseconds.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Uses the FreeRTOS tick delay to suspend the calling task.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - Must be called from a task context (not an ISR).</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Suspends the current task.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ms Delay duration in milliseconds. Zero performs no delay.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">hal_delay_ms</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ms</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="n">ms</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Configures a GPIO pin as a push-pull output.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Sets the pin to output mode with no pull resistors and applies the initial</span>
<span class="cm"> * logic level.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - pin must be a valid output-capable GPIO.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - GPIO is configured for output and driven to initial_level.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Updates GPIO hardware configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * @param pin GPIO number to configure.</span>
<span class="cm"> * @param initial_level Initial logic level to drive.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid pin/config failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_gpio_config_output</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">hal_gpio_level_t</span><span class="w"> </span><span class="n">initial_level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_output_valid</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">gpio_config_t</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">pin_bit_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">pull_up_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PULLUP_DISABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">pull_down_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PULLDOWN_DISABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">intr_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_INTR_DISABLE</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">gpio_set_level</span><span class="p">((</span><span class="n">gpio_num_t</span><span class="p">)</span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">initial_level</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Configures a GPIO pin as an input with pull settings.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Sets the pin to input mode and enables the requested pull-up or pull-down.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - pin must be a valid GPIO.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - GPIO is configured for input with the requested pull configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Updates GPIO hardware configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * @param pin GPIO number to configure.</span>
<span class="cm"> * @param pull Pull mode (none/up/down).</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid pin/config failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_gpio_config_input</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">hal_gpio_pull_t</span><span class="w"> </span><span class="n">pull</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">gpio_config_t</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">pin_bit_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_INPUT</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">pull_up_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pull</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAL_GPIO_PULL_UP</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">GPIO_PULLUP_ENABLE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GPIO_PULLUP_DISABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">pull_down_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pull</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAL_GPIO_PULL_DOWN</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">GPIO_PULLDOWN_ENABLE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GPIO_PULLDOWN_DISABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">intr_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_INTR_DISABLE</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Writes a logic level to a GPIO output.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - pin must be configured as an output-capable GPIO.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Updates the GPIO output level.</span>
<span class="cm"> *</span>
<span class="cm"> * @param pin GPIO number to write.</span>
<span class="cm"> * @param level Logic level to drive.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid pin.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_gpio_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">hal_gpio_level_t</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_output_valid</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">gpio_set_level</span><span class="p">((</span><span class="n">gpio_num_t</span><span class="p">)</span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">level</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Reads the current logic level of a GPIO.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Returns HAL_GPIO_LOW if the pin is invalid.</span>
<span class="cm"> *</span>
<span class="cm"> * @param pin GPIO number to read.</span>
<span class="cm"> * @return HAL_GPIO_HIGH or HAL_GPIO_LOW based on the sampled level.</span>
<span class="cm"> */</span>
<span class="n">hal_gpio_level_t</span><span class="w"> </span><span class="nf">hal_gpio_read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_GPIO_LOW</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">hal_gpio_level_t</span><span class="p">)</span><span class="n">gpio_get_level</span><span class="p">((</span><span class="n">gpio_num_t</span><span class="p">)</span><span class="n">pin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Defines the maximum number of HAL timer slots.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Limits the number of concurrent periodic timers that can be registered via</span>
<span class="cm"> * hal_timer_start().</span>
<span class="cm"> */</span>
<span class="cp">#define HAL_TIMER_MAX 4</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">esp_timer_handle_t</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_timer_callback_t</span><span class="w"> </span><span class="n">callback</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">hal_timer_entry_t</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="n">hal_timer_entry_t</span><span class="w"> </span><span class="n">hal_timers</span><span class="p">[</span><span class="n">HAL_TIMER_MAX</span><span class="p">];</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hal_timer_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">hal_timer_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">hal_timer_entry_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Starts a periodic HAL timer.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Allocates or reuses a timer slot and calls the provided callback at the</span>
<span class="cm"> * specified period.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - timer_id must be in range [0, HAL_TIMER_MAX).</span>
<span class="cm"> * - callback must be non-null.</span>
<span class="cm"> * - period_ms must be &gt; 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - The timer slot is active and invokes callback periodically.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates an ESP timer and schedules periodic callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> * @param timer_id Timer slot identifier.</span>
<span class="cm"> * @param period_ms Period in milliseconds.</span>
<span class="cm"> * @param callback Function to invoke each period. Must not be NULL.</span>
<span class="cm"> * @param user_data Opaque pointer passed to callback.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid parameters or failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_timer_start</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">timer_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">period_ms</span><span class="p">,</span>
<span class="w">                             </span><span class="n">hal_timer_callback_t</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">timer_id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">HAL_TIMER_MAX</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">period_ms</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_timer_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_timers</span><span class="p">[</span><span class="n">timer_id</span><span class="p">];</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">esp_timer_stop</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">esp_timer_delete</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">esp_timer_create_args_t</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_timer_dispatch</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hal_timer&quot;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esp_timer_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callback</span><span class="p">;</span>
<span class="w">    </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_data</span><span class="p">;</span>

<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">period_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">period_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000ULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esp_timer_start_periodic</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">period_us</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">esp_timer_delete</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Stops a periodic HAL timer.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Cancels and deletes the timer slot if it is active.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - timer_id must be in range [0, HAL_TIMER_MAX).</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - The timer slot is inactive.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Deletes the underlying ESP timer if present.</span>
<span class="cm"> *</span>
<span class="cm"> * @param timer_id Timer slot identifier.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid timer_id.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_timer_stop</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">timer_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">timer_id</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">HAL_TIMER_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_timer_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_timers</span><span class="p">[</span><span class="n">timer_id</span><span class="p">];</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">esp_timer_stop</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="n">esp_timer_delete</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">esp_timer_handle_t</span><span class="w"> </span><span class="n">hal_tick_timer</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">hal_timer_callback_t</span><span class="w"> </span><span class="n">hal_tick_callback</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">hal_tick_user_data</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hal_tick_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_tick_callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hal_tick_callback</span><span class="p">(</span><span class="n">hal_tick_user_data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Starts the global HAL tick timer.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Configures a periodic ESP timer that calls the provided callback at the</span>
<span class="cm"> * requested frequency.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - hz must be &gt; 0.</span>
<span class="cm"> * - callback must be non-null.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - The tick callback is invoked at approximately hz.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates and starts an ESP timer.</span>
<span class="cm"> *</span>
<span class="cm"> * @param hz Tick frequency in Hertz.</span>
<span class="cm"> * @param callback Function to invoke on each tick. Must not be NULL.</span>
<span class="cm"> * @param user_data Opaque pointer passed to callback.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid params or failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_tick_start</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hz</span><span class="p">,</span><span class="w"> </span><span class="n">hal_timer_callback_t</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">esp_timer_stop</span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">);</span>
<span class="w">        </span><span class="n">esp_timer_delete</span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">);</span>
<span class="w">        </span><span class="n">hal_tick_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">period_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000ULL</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">hz</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">period_us</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">esp_timer_create_args_t</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_tick_dispatch</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hal_tick&quot;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esp_timer_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_tick_timer</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hal_tick_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_tick_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callback</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_tick_user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_data</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esp_timer_start_periodic</span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">,</span><span class="w"> </span><span class="n">period_us</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">esp_timer_delete</span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">);</span>
<span class="w">        </span><span class="n">hal_tick_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Stops the global HAL tick timer.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Cancels and deletes the tick timer if it is active.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - The global tick timer is inactive.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Deletes the underlying ESP timer.</span>
<span class="cm"> *</span>
<span class="cm"> * @return HAL_OK on success.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_tick_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_tick_timer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">esp_timer_stop</span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">);</span>
<span class="w">    </span><span class="n">esp_timer_delete</span><span class="p">(</span><span class="n">hal_tick_timer</span><span class="p">);</span>
<span class="w">    </span><span class="n">hal_tick_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_tick_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_tick_user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">ledc_timer_t</span><span class="w"> </span><span class="nf">hal_pwm_select_timer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_MOTOR_IN1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_MOTOR_IN2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">LEDC_TIMER_1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">LEDC_TIMER_0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">ledc_timer_bit_t</span><span class="w"> </span><span class="nf">hal_pwm_bits_to_ledc</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bits</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LEDC_TIMER_BIT_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEDC_TIMER_BIT_MAX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_timer_bit_t</span><span class="p">)</span><span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">configured</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">    </span><span class="n">ledc_timer_t</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">duty_max</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">hal_pwm_channel_t</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="n">hal_pwm_channel_t</span><span class="w"> </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">LEDC_CHANNEL_MAX</span><span class="p">];</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">hal_pwm_timer_configured</span><span class="p">[</span><span class="n">LEDC_TIMER_MAX</span><span class="p">];</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hal_pwm_timer_freq</span><span class="p">[</span><span class="n">LEDC_TIMER_MAX</span><span class="p">];</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hal_pwm_timer_bits</span><span class="p">[</span><span class="n">LEDC_TIMER_MAX</span><span class="p">];</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Initializes a PWM channel for a GPIO pin.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Configures the LEDC timer and channel for the requested frequency and</span>
<span class="cm"> * resolution. Motor pins are placed on a separate LEDC timer to preserve</span>
<span class="cm"> * frequency settings.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - channel must be in [0, LEDC_CHANNEL_MAX).</span>
<span class="cm"> * - pin must be a valid output-capable GPIO.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - The PWM channel is configured and ready for duty updates.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates/updates LEDC timer and channel configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * @param channel LEDC channel index.</span>
<span class="cm"> * @param pin GPIO number to drive with PWM.</span>
<span class="cm"> * @param freq_hz PWM frequency in Hertz.</span>
<span class="cm"> * @param duty_resolution_bits Duty resolution in bits.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid params or failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_pwm_init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">freq_hz</span><span class="p">,</span>
<span class="w">                          </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">duty_resolution_bits</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LEDC_CHANNEL_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_output_valid</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ledc_timer_t</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal_pwm_select_timer</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
<span class="w">    </span><span class="n">ledc_timer_bit_t</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal_pwm_bits_to_ledc</span><span class="p">(</span><span class="n">duty_resolution_bits</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_pwm_timer_configured</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">hal_pwm_timer_freq</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">freq_hz</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">hal_pwm_timer_bits</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">duty_resolution_bits</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ledc_timer_config_t</span><span class="w"> </span><span class="n">timer_cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">speed_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEDC_LOW_SPEED_MODE</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">timer_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">duty_resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">freq_hz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">freq_hz</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">clk_cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEDC_AUTO_CLK</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_timer_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer_cfg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">hal_pwm_timer_configured</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">hal_pwm_timer_freq</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">freq_hz</span><span class="p">;</span>
<span class="w">        </span><span class="n">hal_pwm_timer_bits</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duty_resolution_bits</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ledc_channel_config_t</span><span class="w"> </span><span class="n">channel_cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">gpio_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">speed_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEDC_LOW_SPEED_MODE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_channel_t</span><span class="p">)</span><span class="n">channel</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">timer_sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">duty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">hpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_channel_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel_cfg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">configured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duty_resolution_bits</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">duty_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFFU</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">duty_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">duty_resolution_bits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1U</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Updates the PWM duty for a configured channel.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Clamps duty to the configured maximum for the channel before updating.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - channel must be configured via hal_pwm_init().</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Updates LEDC duty and commits it to hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * @param channel LEDC channel index.</span>
<span class="cm"> * @param duty Duty value in channel resolution units.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on invalid params or failure,</span>
<span class="cm"> *         HAL_ERR_UNSUPPORTED if the channel is not configured.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_pwm_set_duty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">duty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">LEDC_CHANNEL_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">configured</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">max_duty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal_pwm_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">duty_max</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duty</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_duty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">duty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_duty</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_set_duty</span><span class="p">(</span><span class="n">LEDC_LOW_SPEED_MODE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_channel_t</span><span class="p">)</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">duty</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_update_duty</span><span class="p">(</span><span class="n">LEDC_LOW_SPEED_MODE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ledc_channel_t</span><span class="p">)</span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Initializes UART0 with the configured pins.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Only UART0 is supported. Pins are defined in hal_config.h and must be set</span>
<span class="cm"> * to non-BOARD_GPIO_UNUSED to enable UART usage.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - uart_id must be UART_NUM_0.</span>
<span class="cm"> * - UART pins must be configured in hal_config.h.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - UART driver is installed and ready for IO.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates UART driver resources.</span>
<span class="cm"> *</span>
<span class="cm"> * @param uart_id UART identifier (must be UART_NUM_0).</span>
<span class="cm"> * @param baud_rate Baud rate in bits per second.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_UNSUPPORTED on unsupported config,</span>
<span class="cm"> *         HAL_ERR_INVALID on invalid parameters or driver failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_uart_init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">baud_rate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UART_NUM_0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_UART0_TX_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">HAL_UART0_RX_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_UART0_TX_PIN</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_UART0_RX_PIN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">uart_config_t</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">baud_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">baud_rate</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">data_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_DATA_8_BITS</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_PARITY_DISABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">stop_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_STOP_BITS_1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">flow_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_HW_FLOWCTRL_DISABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">source_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_SCLK_DEFAULT</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_param_config</span><span class="p">(</span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_UART0_RTS_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">UART_PIN_NO_CHANGE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">HAL_UART0_RTS_PIN</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_UART0_CTS_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">UART_PIN_NO_CHANGE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">HAL_UART0_CTS_PIN</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_set_pin</span><span class="p">(</span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_UART0_TX_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_UART0_RX_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">rts</span><span class="p">,</span><span class="w"> </span><span class="n">cts</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_driver_install</span><span class="p">(</span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Writes data to UART0.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - UART0 has been initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Sends bytes over the UART driver.</span>
<span class="cm"> *</span>
<span class="cm"> * @param uart_id UART identifier (must be UART_NUM_0).</span>
<span class="cm"> * @param data Buffer to write. Must not be NULL.</span>
<span class="cm"> * @param length Number of bytes to write. Must be &gt; 0.</span>
<span class="cm"> * @return Number of bytes written, or HAL_ERR_INVALID on invalid params.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hal_uart_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UART_NUM_0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">uart_write_bytes</span><span class="p">(</span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Reads data from UART0.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Performs a non-blocking read with zero timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - UART0 has been initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * @param uart_id UART identifier (must be UART_NUM_0).</span>
<span class="cm"> * @param data Output buffer. Must not be NULL.</span>
<span class="cm"> * @param length Maximum number of bytes to read. Must be &gt; 0.</span>
<span class="cm"> * @return Number of bytes read, or HAL_ERR_INVALID on invalid params.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hal_uart_read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UART_NUM_0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">uart_read_bytes</span><span class="p">(</span><span class="n">uart_id</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">hal_i2c_initialized</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Initializes the I2C master bus.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Only I2C_NUM_0 is supported. Pins are defined in hal_config.h.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - bus_id must be I2C_NUM_0.</span>
<span class="cm"> * - SDA/SCL pins must be configured and valid.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - I2C driver is installed and ready for transfers.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates I2C driver resources.</span>
<span class="cm"> *</span>
<span class="cm"> * @param bus_id I2C bus identifier (must be I2C_NUM_0).</span>
<span class="cm"> * @param clock_hz Bus clock in Hertz. Zero uses HAL_I2C0_CLOCK_HZ.</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_UNSUPPORTED on unsupported config,</span>
<span class="cm"> *         HAL_ERR_INVALID on invalid parameters or driver failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_i2c_init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clock_hz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bus_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">I2C_NUM_0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_I2C0_SDA_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">HAL_I2C0_SCL_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_I2C0_SDA_PIN</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_I2C0_SCL_PIN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_i2c_initialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">i2c_config_t</span><span class="w"> </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_MODE_MASTER</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sda_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_I2C0_SDA_PIN</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">scl_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_I2C0_SCL_PIN</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sda_pullup_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PULLUP_ENABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">scl_pullup_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PULLUP_ENABLE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">master</span><span class="p">.</span><span class="n">clk_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">clock_hz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">HAL_I2C0_CLOCK_HZ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">clock_hz</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i2c_param_config</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">conf</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i2c_driver_install</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_i2c_initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Writes data to an I2C device.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Uses a blocking transfer with a 100 ms timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - I2C bus has been initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * @param bus_id I2C bus identifier (must be I2C_NUM_0).</span>
<span class="cm"> * @param addr 7-bit I2C device address.</span>
<span class="cm"> * @param data Buffer to write. Must not be NULL.</span>
<span class="cm"> * @param length Number of bytes to write. Must be &gt; 0.</span>
<span class="cm"> * @return Number of bytes written, or HAL_ERR_INVALID on failure,</span>
<span class="cm"> *         HAL_ERR_UNSUPPORTED if the bus is not available.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hal_i2c_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_i2c_init</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_I2C0_CLOCK_HZ</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">esp_err_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_master_write_to_device</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span>
<span class="w">                                               </span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Reads data from an I2C device.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Uses a blocking transfer with a 100 ms timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - I2C bus has been initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * @param bus_id I2C bus identifier (must be I2C_NUM_0).</span>
<span class="cm"> * @param addr 7-bit I2C device address.</span>
<span class="cm"> * @param data Output buffer. Must not be NULL.</span>
<span class="cm"> * @param length Number of bytes to read. Must be &gt; 0.</span>
<span class="cm"> * @return Number of bytes read, or HAL_ERR_INVALID on failure,</span>
<span class="cm"> *         HAL_ERR_UNSUPPORTED if the bus is not available.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hal_i2c_read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_i2c_init</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_I2C0_CLOCK_HZ</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">esp_err_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_master_read_from_device</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span>
<span class="w">                                                </span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">hal_spi_initialized</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">spi_device_handle_t</span><span class="w"> </span><span class="n">hal_spi_device</span><span class="p">;</span>

<span class="cp">#ifdef HAL_SELFTEST</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hal_selftest_tick_cb</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Initializes the SPI bus and device handle.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Only bus_id 0 is supported and mapped to SPI2_HOST. Pins are defined in</span>
<span class="cm"> * hal_config.h.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - SPI pins must be configured and valid.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - SPI bus is initialized and device handle is ready.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates SPI bus resources.</span>
<span class="cm"> *</span>
<span class="cm"> * @param bus_id SPI bus identifier (must be 0).</span>
<span class="cm"> * @param clock_hz Clock rate in Hertz. Zero uses HAL_SPI0_CLOCK_HZ.</span>
<span class="cm"> * @param mode SPI mode (0-3).</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_UNSUPPORTED on unsupported config,</span>
<span class="cm"> *         HAL_ERR_INVALID on invalid parameters or driver failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_spi_init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clock_hz</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bus_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_SPI0_MOSI_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">HAL_SPI0_MISO_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">HAL_SPI0_SCLK_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_SPI0_MOSI_PIN</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_SPI0_MISO_PIN</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">hal_gpio_valid</span><span class="p">(</span><span class="n">HAL_SPI0_SCLK_PIN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_spi_initialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">spi_bus_config_t</span><span class="w"> </span><span class="n">buscfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">mosi_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_SPI0_MOSI_PIN</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">miso_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_SPI0_MISO_PIN</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sclk_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_SPI0_SCLK_PIN</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">quadwp_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">quadhd_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">max_transfer_sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_bus_initialize</span><span class="p">(</span><span class="n">SPI2_HOST</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buscfg</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_DMA_CH_AUTO</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">spi_device_interface_config_t</span><span class="w"> </span><span class="n">devcfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">clock_speed_hz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">clock_hz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">HAL_SPI0_CLOCK_HZ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">clock_hz</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">spics_io_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_SPI0_CS_PIN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">HAL_SPI0_CS_PIN</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">queue_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_bus_add_device</span><span class="p">(</span><span class="n">SPI2_HOST</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">devcfg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_spi_device</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_spi_initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Performs a blocking SPI transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Sends tx bytes (if provided) and optionally captures rx bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - SPI bus has been initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * @param bus_id SPI bus identifier (must be 0).</span>
<span class="cm"> * @param tx Optional transmit buffer (may be NULL).</span>
<span class="cm"> * @param rx Optional receive buffer (may be NULL).</span>
<span class="cm"> * @param length Number of bytes to transfer. Must be &gt; 0.</span>
<span class="cm"> * @return Number of bytes transferred, or HAL_ERR_INVALID on failure,</span>
<span class="cm"> *         HAL_ERR_UNSUPPORTED if the bus is not available.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hal_spi_transfer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_spi_init</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_SPI0_CLOCK_HZ</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_SPI0_MODE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">spi_transaction_t</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">tx_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">rx_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">esp_err_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi_device_transmit</span><span class="p">(</span><span class="n">hal_spi_device</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">adc_oneshot_unit_handle_t</span><span class="w"> </span><span class="n">hal_adc_handle</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">hal_adc_initialized</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Initializes the ADC oneshot unit.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Uses ADC_UNIT_1 and prepares it for per-channel configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Postconditions:</span>
<span class="cm"> * - ADC oneshot handle is available.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Allocates ADC unit resources.</span>
<span class="cm"> *</span>
<span class="cm"> * @return HAL_OK on success, HAL_ERR_INVALID on initialization failure.</span>
<span class="cm"> */</span>
<span class="n">hal_status_t</span><span class="w"> </span><span class="nf">hal_adc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_adc_initialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">adc_oneshot_unit_init_cfg_t</span><span class="w"> </span><span class="n">init_cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">unit_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ADC_UNIT_1</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">adc_oneshot_new_unit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cfg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hal_adc_handle</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_adc_initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Reads a raw ADC sample from the specified channel.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Configures channel attenuation and bit width on each read to match the</span>
<span class="cm"> * default ESP-IDF oneshot configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Preconditions:</span>
<span class="cm"> * - channel must be a valid ADC channel for ADC_UNIT_1.</span>
<span class="cm"> *</span>
<span class="cm"> * @param channel ADC channel number.</span>
<span class="cm"> * @return Raw ADC reading on success, HAL_ERR_INVALID on failure,</span>
<span class="cm"> *         HAL_ERR_UNSUPPORTED if channel is disabled.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hal_adc_read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_adc_init</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_UNSUPPORTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">adc_oneshot_chan_cfg_t</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">atten</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ADC_ATTEN_DB_12</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">bitwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ADC_BITWIDTH_DEFAULT</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">adc_oneshot_config_channel</span><span class="p">(</span><span class="n">hal_adc_handle</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">adc_channel_t</span><span class="p">)</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">adc_oneshot_read</span><span class="p">(</span><span class="n">hal_adc_handle</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">adc_channel_t</span><span class="p">)</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERR_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">raw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief Runs a basic HAL self-test sequence.</span>
<span class="cm"> *</span>
<span class="cm"> * @details</span>
<span class="cm"> * Validates GPIO, tick timer, PWM, and optional peripheral bring-up. Only</span>
<span class="cm"> * compiled when HAL_SELFTEST is defined.</span>
<span class="cm"> *</span>
<span class="cm"> * Side effects:</span>
<span class="cm"> * - Reconfigures GPIO/PWM peripherals for test patterns.</span>
<span class="cm"> * - Writes test output to the UART when available.</span>
<span class="cm"> *</span>
<span class="cm"> * @note Intended for development builds only.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">hal_selftest_run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#ifndef HAL_SELFTEST</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HAL self-test start&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">led_pins</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">BOARD_GPIO_LED0</span><span class="p">,</span>
<span class="w">        </span><span class="n">BOARD_GPIO_LED1</span><span class="p">,</span>
<span class="w">        </span><span class="n">BOARD_GPIO_LED2</span><span class="p">,</span>
<span class="w">        </span><span class="n">BOARD_GPIO_LED3</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">led_pins</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">led_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_gpio_config_output</span><span class="p">(</span><span class="n">led_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">HAL_GPIO_LOW</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hal_gpio_write</span><span class="p">(</span><span class="n">led_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">HAL_GPIO_HIGH</span><span class="p">);</span>
<span class="w">            </span><span class="n">hal_delay_ms</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="w">            </span><span class="n">hal_gpio_write</span><span class="p">(</span><span class="n">led_pins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">HAL_GPIO_LOW</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">hal_gpio_config_input</span><span class="p">(</span><span class="n">BOARD_GPIO_BUTTON_FWD</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_GPIO_PULL_UP</span><span class="p">);</span>
<span class="w">    </span><span class="n">hal_gpio_config_input</span><span class="p">(</span><span class="n">BOARD_GPIO_BUTTON_REV</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_GPIO_PULL_UP</span><span class="p">);</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Button FWD=%d REV=%d&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">hal_gpio_read</span><span class="p">(</span><span class="n">BOARD_GPIO_BUTTON_FWD</span><span class="p">),</span>
<span class="w">             </span><span class="n">hal_gpio_read</span><span class="p">(</span><span class="n">BOARD_GPIO_BUTTON_REV</span><span class="p">));</span>

<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tick_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">hal_tick_start</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">hal_selftest_tick_cb</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tick_count</span><span class="p">);</span>
<span class="w">    </span><span class="n">hal_delay_ms</span><span class="p">(</span><span class="mi">1100</span><span class="p">);</span>
<span class="w">    </span><span class="n">hal_tick_stop</span><span class="p">();</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Tick count (1s): %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">tick_count</span><span class="p">);</span>

<span class="w">    </span><span class="n">hal_pwm_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BOARD_GPIO_LED0</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_PWM_LED_FREQ_HZ</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_PWM_DUTY_RES_BITS</span><span class="p">);</span>
<span class="w">    </span><span class="n">hal_pwm_set_duty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_PWM_DUTY_RES_BITS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hal_uart_init</span><span class="p">(</span><span class="n">UART_NUM_0</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_UART0_BAUD_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">banner</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;HAL UART0 ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">hal_uart_write</span><span class="p">(</span><span class="n">UART_NUM_0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">banner</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">banner</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_I2C0_SDA_PIN</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">HAL_I2C0_SCL_PIN</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hal_i2c_init</span><span class="p">(</span><span class="n">I2C_NUM_0</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_I2C0_CLOCK_HZ</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_SPI0_MOSI_PIN</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">HAL_SPI0_SCLK_PIN</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hal_spi_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_SPI0_CLOCK_HZ</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_SPI0_MODE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_ADC_DEFAULT_CHANNEL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BOARD_GPIO_UNUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">adc_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal_adc_read</span><span class="p">(</span><span class="n">HAL_ADC_DEFAULT_CHANNEL</span><span class="p">);</span>
<span class="w">        </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ADC default channel=%d value=%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_ADC_DEFAULT_CHANNEL</span><span class="p">,</span><span class="w"> </span><span class="n">adc_value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;HAL self-test complete&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PickPlaz ESP32-C3 Port 0.0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Program Listing for File hal.c</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2026, Asterion Daedalus.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.1.0.
    </div>
  </body>
</html>